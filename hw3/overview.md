# Домашняя работа №3

## Опишите схему события в формате json schema 

Формальное событие: стриминг информации о менеджере

```json
{
    'additionalProperties': False,
    'properties': {
        'manager_id': {
            'description': 'Идентификатор менеджера',
            'title': 'Manager Id',
            'type': 'integer'
        },
        'name': {
            'description': 'Имя менеджера',
            'title': 'Name',
            'type': 'string'
        },
        'surname': {
            'description': 'Фамилия менеджера',
            'title': 'Surname',
            'type': 'string'
        },
        'work_email': {
            'description': 'Рабочая почта менеджера',
            'title': 'Work Email',
            'type': 'string'
        },
        'staff_login': {
            'description': 'Логин менеджера',
            'title': 'Staff Login',
            'type': 'string'
        },
        'created_at': {
            'description': 'Время регистрации менеджера на платформе',
            'title': 'Created At',
            'type': 'string'
        }
    },
    'required': [
        'manager_id',
        'name',
        'surname',
        'work_email',
        'staff_login',
        'created_at'
    ],
    'title': 'ManagerCreated',
    'type': 'object'
}

```

Функциональное событие, что задание выполнено успешно

```json
{
    '$defs': {
        'TaskCompletedSuccessfulPayload': {
            'additionalProperties': False,
            'properties': {
                'task_id': {
                    'description': 'Идентификатор задания',
                    'title': 'Task Id',
                    'type': 'integer'
                },
                'candidate_id': {
                    'description': 'Идентификатор кандидата, кто выполнял задание',
                    'title': 'Candidate Id',
                    'type': 'integer'
                },
                'manager_id': {
                    'description': 'Идентификатор менеджера, ответственного за задание',
                    'title': 'Manager Id',
                    'type': 'integer'
                }
            },
            'required': ['task_id', 'candidate_id', 'manager_id'],
            'title': 'TaskCompletedSuccessfulPayload',
            'type': 'object'
        }
    },
    'additionalProperties': False,
    'properties': {
        'event_id': {
            'description': 'Идентификатор события',
            'title': 'Event Id',
            'type': 'integer'
        },
        'event_name': {
            'default': 'TaskCompletedSuccessful',
            'description': 'Название события',
            'title': 'Event Name',
            'type': 'string'
        },
        'event_version': {
            'default': 0,
            'description': 'Версия события',
            'title': 'Event Version',
            'type': 'integer'
        },
        'created_at': {
            'description': 'Время создания события',
            'title': 'Created At',
            'type': 'string'
        },
        'payload': {'$ref': '#/$defs/TaskCompletedSuccessfulPayload'}
    },
    'required': ['event_id', 'payload'],
    'title': 'TaskCompletedSuccessfulEvent',
    'type': 'object'
}

```

## Опешите переход с одной связи на другую

### Переход формальной синхронной на асинхронную event-driven

Для миграции возьмем в пример COMM-010, где изначально сделана синхронная связь для получения информации о менеджере. В итоге связь становится асинхронной.

1. Создаем схему события (например json схема)
2. Добавляем схему в schema registry 
3. Добавялем консьюмер который будет обрабатывать и сохранять информация о менеджерах
4. Добавляем продьюсер, который будет класть инфу в топик про менеджеров
5. Выключаем синхронную связь 
6. Чистим код и обновляем документацию 

### Переход формальной асинхронной event-driven на синхронную

Для миграции возьмем в пример COMM-060, где изначально сделана aсинхронная связь для получения информации о рейтинге. В процессе рефакторинга системы, стало понятно, что нужна синхронная связь.

1. Выбираем стратегию получения данных синхронно (`pull/push`). Останавливаемся на `pull`
2. Добавляем в сервис заданий новую ручку для получения актуального рейтинга
3. В логике расчета бонусов, меняем поход в базу сервиса за рейтингом (или где внутри хранится рейтинг который консьюмер складывал из соответвующего топика) на вызов нового эндпоинта
4. Останваливаем продюсер
5. Выключаем консьюмер
6. Удаляем код, таблицы и обновляем доки

### Переход функциональной синхронной на асинхронную event-driven

Для миграции возьмем коммуникацию COMM-040, где изначально синхронно вызывали сервси бонусов для начисления бонусов при успешно выполненном задании. Сейчас асинхронно отправляем событие о том что задание успешно выполнено.

1. Добавляем схему события в schema registry
2. Делаем консьюмер, который будет обрабатывать событие о правильно решенном задании
3. Добавляем продьюсер который будет отправлять данное событие
4. Выключаем старую синхронную коммуникацию
5. Чистим код и правим доки

### Переход функциональной асинхронной event-driven на синхронную

В новых коммуникациях нет синхронной функциональной связи


## Процесс миграции одной формальной и одной функциональной связи для новых требований бизнеса

- [US-160] Разбейте названия заданий [Knowledge Area] Title на knowledge area и title. Это нужно сделать во всех местах, где есть старое название.
- [US-170] Необходимо анонимизировать информацию о менеджерах, чтобы агрессивные кандидаты не могли угрожать несчастным менеджерам.


При доработках по US-160 будет задета в частности и асинхронная формальная связь отправки 

1. Добавляем schema registry нулевую версию события если его там нет
2. Добавляем новое событие в schema registry
3. Поддерживаем в консьюмере версионирование (если не было) и новую версию события
4. Продюсер начинает отправлять событие с новой версией
5. Удаляем продьюсинг старой версии события
6. Ждем пока обработаются все старые события
7. Чистим код и правим документацию

При доработках по US-170 будет задета функциональная связь 
