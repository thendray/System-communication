# Домашнее задание N4

## ADR 1: выбираем тип связи для стриминга рейтинга

### Status

Proposed

### Context

Для начисления бонусов (определения его размера), сервис с бонусами должен знать актуальный на момент расчета бонуса рейтинг задания.
В текущей системе рейтинг передается асинхронно через распределнный лог (kafka), где продьюсером является сервис найма, а консьюмером - сервис бонусов.

Такое решение приводит к ряду проблем, например из-за асинхронного подхода нет выполняется требование о максимально актуальном значении на момент расчета.

![](img1.png)

### Decisions

Единственный способ решить проблему с задежрками при расчете рейтинга, это перейти с асинхронной связи на синхронную. Для этого используем формат 
`request-response`. Также выьираем модель обмена данными (push/pull). Здесь больше подойдет push так как при такой реализации мы не завязываемся на ответ от сервиса найма при расчете бонусов и операции будут проводиться быстрее.  

### Consequences

Получим максимально актуальную информацию про рейтинг так как он будет обновляться синхронно в момент его изменения в сервисе найма.


## Таблица с проблемами 

| Название проблемы | Краткое описание проблемы                                                                                                                                                                                                                                                                                 | Из-за чего возникла проблема                                                                                                                                                                                                                                                                    | Как проблема решилась                                                                                                                                                                 |
|-------------------|-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| `[Problem-010]`   | Долго определяется правильность выполнения задания от кандидата                                                                                                                                                                                                                                           | Проблема возникает из-за большого количества синхронных вызовов в данном процессе. (Получение информации о задании, синхронное начисление/списание бонусов)                                                                                                                                     | Перевели синхронные связи на асинхронные. Сделали событийный-реакционный подход, когда сервис-продьюсер говорит что случилось, а сервисы консьюмеры уже сами решают что делать с этим |
| `[Problem-020]`   | Кандидаты в учителя читерят систему в месте, где простое задание должно усложниться, но этого ещё не произошло.                                                                                                                                                                                           | По идее: проблема в синхронном получение информации о задании: то есть задание может обновиться давно, но за обновлением сервис найма должен прийти сам                                                                                                                                         | Перевели стриминг заданий на асинхронный процесс и стиминг обновлений на синхронный                                                                                                   |
| `[Problem-030]`   | Логика начисления бонусов некорректна из-за ошибки с рейтингом задания. Во время начисления бонусов во время изменения рейтинга, происходит задержка, которая не удовлетворяет бизнес                                                                                                                     | Из-за того что рейтинг передавался асинхронно не получалось гарантировать актуальность в моменте                                                                                                                                                                                                | Сделали синхронный стриминг рейтинга, чтоб брать его максимально актуальным на момент расчета бонусов                                                                                 |
| `[Problem-040]`   | Медленно начисляются бонусы менеджерам, потому что много кандидатов в учителя. Иногда вся система падает и не восстанавливается.                                                                                                                                                                          | Из-за синхронных начислений/списаний бонусов сервис найма и бонусов сильно связаны: нагрузка сервиса найма напрямую влияет на сервис бонусов                                                                                                                                                    | Перевели на асинхронные события                                                                                                                                                       |
| `[Problem-050]`   | Медленно начисляются бонусы менеджерам, потому что много кандидатов в учителя. Иногда вся система падает и не восстанавливается.                                                                                                                                                                          | Из-за синхронных вызовов и связности сервисов, успешность выполененого задания зависит не только от правильности решения но и от тог смог ли менеджер получить бонусы                                                                                                                           | Разделили процессы, отделив проверку задания от расчета и начисления бонусов за счет асинхронных событий от сервиса найма к сервису брнусов                                           |
| `[Problem-060]`   | Нужно сократить расходы на скейлинг сервиса заданий. Сейчас дорого.                                                                                                                                                                                                                                       | Причины все те же: много синхронных связей которые обязывают все сервисы дерюать нагрузку друг друга                                                                                                                                                                                            | Передлали стриминг и работу с заданиям на асинхронную свзяь и теперь каждый сервис может в рамках своих возможностей работать с событиями                                             |
| `[Problem-070]`   | Менеджерам иногда начисляются бонусы дважды. Это связано с тем, что, когда кандидаты в учителя отправляют то же самое задание повторно, система тупит [Problem-050]. Разработчики объясняют тем, что управление заданиями падает, а бонусами — нет. Из-за этого бонусы попадают в два одинаковых запроса. | Отсутствие идемпотентности при начислении/списании бонусов                                                                                                                                                                                                                                      | Делаем начисление бонусов идемпотентными (например через какой нибудь лог операций и уникальный ключ)                                                                                 |
| `[Problem-080]`   | Упавший сервис создания заданий или бонусов кладёт всю систему, и кандидаты в учителя не могут выполнять задания.                                                                                                                                                                                         | Сильная связность сервисов из-за синхронных связей                                                                                                                                                                                                                                              | Убрали обилие синхронных связей, за счет чего сервисы стали более слабо связаны                                                                                                       |
| `[Problem-090]`   | Фичи выходят слишком медленно. Плохая документация                                                                                                                                                                                                                                                        | Ну видимо кроме кода ничего больше не делалось, коммуникации не выстроены, документацию никто не пишет. + сами по себе процессы запутанные и сильно связаны                                                                                                                                     | Разобрали и упростили процессы, добавили ES data model communication model, порефакторили нейминги и ввели практику написания ADR                                                     |
| `[Problem-100]`   | Данные теряются вокруг логики выполнения заданий кандидатами в учителя.                                                                                                                                                                                                                                   | Возможно из-за отсутствия ретраев и каких либо асинхронных процессов подхватывающих упавшие процессы. По идее актором выступает кандидат и если он после ошибки заново что то не введет/проыкает в UI то система не будет как то повторно обрабатывать то что не смогла обработать в первый раз | При асинхронных событиях есть возможность обработать его повторно или переложить в DLQ который потом отдельно можно разобрать                                                         |

